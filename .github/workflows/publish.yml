name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'  # Trigger on any tag starting with 'v'
  release:
    types: [created]  # Also support GitHub Releases for backward compatibility
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v3.27.0)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create GitHub Releases
      id-token: write  # For trusted publishing (optional, for future use)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # For push events, GITHUB_REF is the tag ref (e.g., refs/tags/v3.27.1)
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
      
      - name: Verify version matches pyproject.toml
        id: verify_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_VERSION="${{ github.event.inputs.version }}"
            # Remove 'v' prefix if present
            TAG_VERSION=${TAG_VERSION#v}
          else
            # For push (tags) or release events, use the extracted version
            TAG_VERSION="${{ steps.version.outputs.version }}"
          fi
          
          # Extract version from pyproject.toml (compatible with Python 3.8+)
          PYPROJECT_VERSION=$(python -c "import re; f=open('pyproject.toml','r'); content=f.read(); f.close(); match=re.search(r'version\s*=\s*[\"\\']([^\"\\']+)[\"\\']', content); print(match.group(1) if match else '')")
          
          echo "Tag version: $TAG_VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "❌ Version mismatch! Tag version ($TAG_VERSION) does not match pyproject.toml version ($PYPROJECT_VERSION)"
            exit 1
          fi
          
          echo "✅ Version matches"
      
      - name: Run tests
        run: |
          pip install -e ".[dev]"
          python -m pytest tests/unit/ -v -x --tb=short -m "not performance" || true
          echo "Note: Tests are run but don't block publish (you can make this required if desired)"
      
      - name: Build package
        run: |
          python -m build
      
      - name: Check package
        run: |
          twine check dist/*
      
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          twine upload dist/*
      
      - name: Extract release notes from CHANGELOG.md
        if: github.event_name == 'push'
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          python3 << 'EOF'
          import os
          import re
          
          version = os.environ['VERSION']
          
          # Read CHANGELOG.md
          with open('CHANGELOG.md', 'r') as f:
              content = f.read()
          
          # Try to find the section for this version (with or without 'v' prefix)
          patterns = [
              rf'^## {re.escape(version)} —',
              rf'^## v{re.escape(version)} —',
          ]
          
          release_notes = None
          for pattern in patterns:
              match = re.search(pattern, content, re.MULTILINE)
              if match:
                  # Extract everything from this section until the next ## section
                  start = match.end()
                  next_section = re.search(r'^## ', content[start:], re.MULTILINE)
                  if next_section:
                      release_notes = content[start:start + next_section.start()].strip()
                  else:
                      release_notes = content[start:].strip()
                  break
          
          # If not found, create a basic release note
          if not release_notes:
              release_notes = f"Release v{version}\n\nSee CHANGELOG.md for details."
          
          # Write to output using multiline format
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write('notes<<EOF\n')
              f.write(release_notes)
              f.write('\nEOF\n')
          EOF
      
      - name: Create GitHub Release (if tag push)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish confirmation
        run: |
          echo "✅ Published to PyPI: https://pypi.org/project/sparkless/${{ steps.version.outputs.version }}/"
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "✅ GitHub Release created: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          else
            echo "✅ Release created: ${{ github.event.release.html_url }}"
          fi
