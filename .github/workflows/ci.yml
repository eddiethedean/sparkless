name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  lint-and-type:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Ruff format check
        run: ruff format --check .
      - name: Ruff lint
        run: ruff check .
      - name: Type check
        run: mypy sparkless tests

  test-unit:
    runs-on: ubuntu-latest
    needs: lint-and-type
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Run unit tests (parallel)
        env:
          TZ: "America/New_York"
        run: python3 -m pytest tests/unit/ -v -n 8 --dist loadfile --tb=short -m "not performance" --cov=sparkless --cov-report=xml --cov-report=term-missing --cov-report=html
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: |
            coverage.xml
            htmlcov
          if-no-files-found: ignore

  test-parity:
    runs-on: ubuntu-latest
    needs: lint-and-type
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Run parity tests (PySpark parity validation)
        env:
          TZ: "America/New_York"
        run: python3 -m pytest tests/parity/ -v -n 8 --dist loadfile --tb=short --cov=sparkless --cov-report=xml --cov-report=term-missing --cov-report=html
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-parity
          path: |
            coverage.xml
            htmlcov
          if-no-files-found: ignore

  test-compatibility:
    runs-on: ubuntu-latest
    needs: lint-and-type
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Run compatibility tests (parallel)
        env:
          TZ: "America/New_York"
        run: |
          set +e  # Don't exit on error
          python3 -m pytest tests/compatibility/ -v -n 8 --dist loadfile --tb=short --cov=sparkless --cov-report=xml --cov-report=term-missing --cov-report=html
          exit_code=$?
          set -e  # Re-enable exit on error
          # Exit code 5 means no tests collected - that's okay, just skip
          if [ $exit_code -eq 5 ]; then
            echo "No compatibility tests found, skipping..."
            exit 0
          fi
          exit $exit_code
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-compatibility
          path: |
            coverage.xml
            htmlcov
          if-no-files-found: ignore

  test-performance:
    runs-on: ubuntu-latest
    needs: lint-and-type
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Run performance tests
        env:
          TZ: "America/New_York"
        run: |
          set +e  # Don't exit on error
          python3 -m pytest tests/unit/ -v -m performance --tb=short --cov=sparkless --cov-report=xml --cov-report=term-missing --cov-report=html
          exit_code=$?
          set -e  # Re-enable exit on error
          # Exit code 5 means no tests collected - that's okay, just skip
          if [ $exit_code -eq 5 ]; then
            echo "No performance tests found, skipping..."
            exit 0
          fi
          exit $exit_code
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-performance
          path: |
            coverage.xml
            htmlcov
          if-no-files-found: ignore

  test-documentation:
    runs-on: ubuntu-latest
    needs: lint-and-type
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -e ".[dev]"
      - name: Run documentation tests (parallel)
        env:
          TZ: "America/New_York"
        run: python3 -m pytest tests/documentation/ -v -n 8 --dist loadfile --tb=short --cov=sparkless --cov-report=xml --cov-report=term-missing --cov-report=html
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-documentation
          path: |
            coverage.xml
            htmlcov
          if-no-files-found: ignore

